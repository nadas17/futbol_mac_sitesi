<!DOCTYPE html>
<html lang="en"></html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Match</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>

    <div class="container">
        <h1 class="create-match-title">Create New Match</h1>
        <form id="create-match-form">
            <div class="step-progress-bar">
                <div class="step-progress-bar-inner" id="progressBar"></div>
            </div>
            <div class="form-steps">
                <div class="form-step active" data-step="0">
                    <label for="title">Match Title:</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-step" data-step="1">
                    <label for="match_date">Date:</label>
                    <input type="date" id="match_date" name="match_date" required>
                </div>
                <div class="form-step" data-step="2">
                    <label for="match_time">Time:</label>
                    <input type="time" id="match_time" name="match_time" required>
                </div>
                <div class="form-step" data-step="3">
                    <label for="location">Location:</label>
                    <input type="text" id="location" name="location" required>
                </div>
                <div class="form-step" data-step="4">
                    <label for="max_players">Maximum Number of Players:</label>
                    <input type="number" id="max_players" name="max_players" min="2" max="30" required>
                </div>
                <div class="form-step" data-step="5">
                    <label for="price_per_player">Price (PLN/player):</label>
                    <input type="number" id="price_per_player" name="price_per_player" min="0" step="0.01">
                </div>
                <div class="form-step" data-step="6">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
            </div>
            <div class="form-navigation">
                <button type="button" id="prevBtn" class="nav-btn" style="display: none;">Previous</button>
                <button type="button" id="nextBtn" class="nav-btn">Next</button>
                <button type="submit" id="submitBtn" style="display: none;">Create Match</button>
            </div>
            <div id="form-message" class="message" style="display: none;"></div>
        </form>
    </div>

    <script>
        // Load Supabase credentials from config.js
        const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.env;

        // Supabase başlat
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            let currentStep = 0;
            const form = document.getElementById('create-match-form');
            const formSteps = document.querySelectorAll('.form-step');
            const totalSteps = formSteps.length;
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const submitBtn = document.getElementById('submitBtn');
            const messageDiv = document.getElementById('form-message');

            function showStep(stepNumber) {
                formSteps.forEach((step, idx) => {
                    step.classList.toggle('active', idx === stepNumber);
                });
                // Progress bar
                const progressBar = document.getElementById('progressBar');
                const percent = ((stepNumber + 1) / totalSteps) * 100;
                progressBar.style.width = percent + '%';

                prevBtn.style.display = stepNumber === 0 ? 'none' : 'block';
                nextBtn.style.display = stepNumber === totalSteps - 1 ? 'none' : 'block';
                submitBtn.style.display = stepNumber === totalSteps - 1 ? 'block' : 'none';
            }

            nextBtn.addEventListener('click', () => {
                const fields = formSteps[currentStep].querySelectorAll('input, textarea');
                let valid = true;
                fields.forEach(field => {
                    field.classList.remove('invalid');
                    if (field.required && !field.value.trim()) {
                        field.classList.add('invalid');
                        valid = false;
                    }
                });
                if (!valid) return;

                if (currentStep < totalSteps - 1) {
                    currentStep++;
                    showStep(currentStep);
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    showStep(currentStep);
                }
            });

            showStep(currentStep);

            // Form submit
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                // Son adım validasyonu
                const lastInput = formSteps[currentStep].querySelector('input, textarea');
                if (lastInput && !lastInput.value.trim()) {
                    lastInput.classList.add('invalid');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';

                // Form verilerini topla
                const title = document.getElementById('title').value;
                const match_date = document.getElementById('match_date').value;
                const match_time = document.getElementById('match_time').value;
                const location = document.getElementById('location').value;
                const max_players = parseInt(document.getElementById('max_players').value);
                const priceInput = document.getElementById('price_per_player').value;
                const price_per_player = priceInput === '' || parseFloat(priceInput) === 0 ? null : parseFloat(priceInput);
                const description = document.getElementById('description').value || null;

                const { data, error } = await supabaseClient
                    .from('matches')
                    .insert([{
                        title,
                        match_date,
                        match_time,
                        location,
                        max_players,
                        price_per_player,
                        description,
                        current_players: 0
                    }]);

                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Match';

                if (error) {
                    showMessage('Failed to create match: ' + error.message, 'error');
                } else {
                    showMessage('Match created successfully!', 'success');
                    form.reset();
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            });

            function showMessage(msg, type) {
                if (!messageDiv) return; // Eğer div yoksa hata vermesin
                messageDiv.textContent = msg;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>