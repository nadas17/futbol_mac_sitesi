<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maç Organizasyon Sitesi</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Add Montserrat font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Update the body styles */
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: #ee7752; /* Fallback for low-end devices */
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        /* Add the gradient animation */
        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Layout Container */
        .layout-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Typography */
        h1, h2, h3 {
            color: #0288d1;
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }

        /* Cards & Containers */
        .match-card, .sidebar, .countdown {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }

        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Buttons */
        .join-match-btn, .admin-link {
            background-color: #0288d1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .join-match-btn:hover:not(:disabled),
        .admin-link:hover {
            background-color: #0277bd;
            transform: translateY(-1px);
        }

        .join-match-btn:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }

        /* Countdown Timer */
        .countdown {
            background: rgba(248, 249, 250, 0.95);
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .countdown-number {
            font-size: 1.75rem;
            font-weight: 700;
            color: #004d40;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .countdown-number div {
            text-align: center;
        }

        .countdown-number span {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            min-width: 3ch;
            display: inline-block;
        }

        .time-label {
            font-size: 0.875rem;
            color: #666;
            margin-top: 5px;
        }

        /* Participants List */
        .participants-list {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
        }

        .participants-list h4 {
            margin: 0 0 0.5rem 0;
            color: #0288d1;
            font-size: 1rem;
        }

        .participants-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .participants-list li {
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.9rem;
            color: #333;
        }

        /* Stats Container */
        .stats-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
        }

        .stats-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .stats-item:hover {
            background-color: #f8f9fa;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .layout-container {
                grid-template-columns: 1fr;
            }

            body {
                padding: 12px;
            }

            .match-card {
                padding: 16px;
            }

            h1 { font-size: 1.75rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }
        }

        /* Form Elements */
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #0288d1;
            box-shadow: 0 0 0 3px rgba(2, 136, 209, 0.1);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        /* Site Title Box Style */
        .site-title {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .site-title h1 {
            margin: 0;
            color: #0288d1;
            font-weight: 600;
        }

        .site-title p {
            margin: 10px 0 0 0;
            color: #666;
        }

        /* New Match Button Styling */
        .new-match {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Section Box Styling */
        .section-box {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-box h2 {
            margin-top: 0;
            color: #0288d1;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Dynamic Button Styling */
        .dynamic-button {
            display: inline-block;
            background-color: #0288d1;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dynamic-button:hover {
            background-color: #0277bd;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .dynamic-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="layout-container">
        <div class="main-content">
            <div class="site-title">
                <h1>Futbol Maçı Organizasyon Sitesi'ne Hoş Geldiniz!</h1>
                <p>Bu site, futbol maçları organize etmek ve katılmak isteyenler için bir platformdur.</p>
            </div>

            <div class="new-match">
                <a href="create_match.html" class="dynamic-button">Yeni Maç Oluştur</a>
            </div>

            <div class="section-box">
                <h2>Yaklaşan Maçlar</h2>
                <div id="matches-container">
                    <!-- This will dynamically load matches -->
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div id="next-match-countdown" class="countdown">
                <h3>Sıradaki Maç</h3>
                <div class="countdown-number">
                    <div>
                        <span id="days">00</span>
                        <div class="time-label">gün</div>
                    </div>
                    <div>
                        <span id="hours">00</span>
                        <div class="time-label">saat</div>
                    </div>
                    <div>
                        <span id="minutes">00</span>
                        <div class="time-label">dakika</div>
                    </div>
                </div>
                <div id="next-match-info"></div>
            </div>

            <div class="stats-container">
                <h3>Katılımcı İstatistikleri</h3>
                <div id="participant-stats">
                    Yükleniyor...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Replace these with your actual Supabase credentials
    const SUPABASE_URL = 'https://cqmtrzgvtvlxobeyuquu.supabase.co'; // Your Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxbXRyemd2dHZseG9iZXl1cXV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzQ1MDUsImV4cCI6MjA2Mzc1MDUwNX0.FoB2vZZWMmR2o5-imFN1ijAdRxTr-R1ykXwOtYNCD3I'; // Your Supabase Anon Key

    // Supabase bağlantısı
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Maçları çek ve ekrana bas
    async function fetchMatches() {
        const matchesContainer = document.getElementById('matches-container');
        matchesContainer.innerHTML = '<p>Maçlar yükleniyor...</p>';

        let { data: matches, error } = await supabase
            .from('matches')
            .select('*')
            .order('match_date', { ascending: true })
            .order('match_time', { ascending: true });

        if (error) {
            matchesContainer.innerHTML = '<p>Maçlar yüklenemedi.</p>';
            return;
        }

        matchesContainer.innerHTML = '';
        for (const match of matches) {
            const matchElement = document.createElement('div');
            matchElement.className = 'match-card';
            matchElement.innerHTML = `
                <h3>${match.title}</h3>
                <p><strong>Tarih:</strong> ${new Date(match.match_date).toLocaleDateString('tr-TR')}</p>
                <p><strong>Saat:</strong> ${match.match_time.substring(0, 5)}</p>
                <p><strong>Konum:</strong> ${match.location}</p>
                <p><strong>Kişi Sayısı:</strong> <span class="participant-count">${match.current_players}</span> / ${match.max_players}</p>
                <div class="participants-list">
                    <ul id="participants-${match.id}">Yükleniyor...</ul>
                </div>
                <button class="join-match-btn" data-match-id="${match.id}">Maça Katıl</button>
            `;
            matchesContainer.appendChild(matchElement);

            matchElement.querySelector('.join-match-btn').onclick = () => addParticipantToMatch(match.id);
            fetchParticipants(match.id);
        }
        updateCountdown(matches);
    }

    // Katılımcıları çek ve listele
    async function fetchParticipants(matchId) {
        const participantsList = document.getElementById(`participants-${matchId}`);
        if (!participantsList) return;

        const { data: participants, error } = await supabase
            .from('match_participants')
            .select('participant_name')
            .eq('match_id', matchId)
            .order('id', { ascending: true });

        if (error) {
            participantsList.innerHTML = '<li>Katılımcılar yüklenemedi</li>';
            return;
        }

        // Katılımcı sayısını güncelle
        const matchCard = participantsList.closest('.match-card');
        if (matchCard) {
            const countElem = matchCard.querySelector('.participant-count');
            if (countElem) countElem.textContent = participants.length;
        }

        participantsList.innerHTML = participants.length > 0
            ? participants.map(p => `<li>${p.participant_name}</li>`).join('')
            : '<li>Henüz katılımcı yok</li>';
    }

    // Katılımcı ekle
    async function addParticipantToMatch(matchId) {
        const participantName = prompt("Maça katılmak için adınızı girin:");
        if (!participantName || participantName.trim() === '') {
            alert("Lütfen geçerli bir isim girin.");
            return;
        }

        // Katılımcı sayısını kontrol et
        const { data: currentMatch } = await supabase
            .from('matches')
            .select('current_players, max_players')
            .eq('id', matchId)
            .single();

        const { data: currentParticipants } = await supabase
            .from('match_participants')
            .select('id')
            .eq('match_id', matchId);

        if (currentParticipants.length >= currentMatch.max_players) {
            alert('Üzgünüz, bu maç doldu!');
            fetchMatches();
            return;
        }

        await supabase
            .from('match_participants')
            .insert([{ match_id: matchId, participant_name: participantName.trim() }]);

        // current_players güncelle (isteğe bağlı)
        await supabase
            .from('matches')
            .update({ current_players: currentParticipants.length + 1 })
            .eq('id', matchId);

        alert(`${participantName.trim()} olarak maça katıldınız!`);
        fetchMatches();
    }

    // Updates the countdown timer for the next match
    let timerInterval = null;

async function updateCountdown(matches) {
    const countdownElement = document.getElementById('next-match-countdown');
    if (!matches || matches.length === 0) {
        countdownElement.innerHTML = '<h3>Sıradaki Maç</h3><p>Yaklaşan maç bulunmamaktadır.</p>';
        return;
    }

    const nextMatch = matches[0];
    const matchDate = new Date(`${nextMatch.match_date}T${nextMatch.match_time}`);
    const nextMatchInfo = document.getElementById('next-match-info');
    nextMatchInfo.innerHTML = `
        <p>${nextMatch.title}</p>
        <p>${matchDate.toLocaleDateString('tr-TR')} - ${nextMatch.match_time.substring(0, 5)}</p>
    `;

    // Eski interval varsa temizle
    if (timerInterval) clearInterval(timerInterval);

    function updateTimer() {
        const now = new Date();
        const distance = matchDate - now;

        if (distance < 0) {
            clearInterval(timerInterval);
            countdownElement.innerHTML = '<h3>Sıradaki Maç</h3><p>Maç başladı!</p>';
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('days').textContent = String(days).padStart(2, '0');
        document.getElementById('hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
    }

    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}

    // Fetches and displays participant statistics
    async function updateParticipantStats() {
        const { data: stats, error } = await supabase
            .from('match_participants')
            .select('participant_name, count:count(*)')
            .group('participant_name')
            .order('count', { ascending: false })
            .limit(5);

        if (error) {
            console.error('İstatistikler yüklenirken hata:', error);
            return;
        }

        const statsHtml = stats
            .map(({ participant_name, count }) => `
                <div class="stats-item">
                    <strong>${participant_name}</strong>: ${count} maç
                </div>
            `)
            .join('');

        document.getElementById('participant-stats').innerHTML = statsHtml || 'Henüz katılım yok.';
    }

    // Sayfa yüklendiğinde maçları çek
    fetchMatches();

        async function addParticipantToMatch(matchId) {
            const participantName = prompt("Maça katılmak için adınızı girin:");

            if (!participantName || participantName.trim() === '') {
                alert("Lütfen geçerli bir isim girin.");
                return;
            }

            // Önce maçın güncel durumunu kontrol et (başka biri aynı anda katılmış olabilir)
            const { data: currentMatch, error: fetchMatchError } = await supabase
                .from('matches')
                .select('current_players, max_players')
                .eq('id', matchId)
                .single();

            if (fetchMatchError) {
                console.error('Maç bilgisi çekilirken hata oluştu:', fetchMatchError);
                alert('Maç durumu kontrol edilirken bir hata oluştu, lütfen tekrar deneyin.');
                return;
            }
            
            // Katılımcıları da çekip sayısını kontrol edelim, current_players sütununa güvenmek yerine
            const { data: currentParticipants, error: fetchParticipantsError } = await supabase
                .from('match_participants')
                .select('id', { count: 'exact' }) // Sadece sayısını almak için
                .eq('match_id', matchId);

            if (fetchParticipantsError) {
                console.error('Katılımcı sayısı çekilirken hata oluştu:', fetchParticipantsError);
                alert('Katılımcı sayısı kontrol edilirken bir hata oluştu, lütfen tekrar deneyin.');
                return;
            }
            
            const actualParticipantCount = currentParticipants ? currentParticipants.length : 0;


            if (actualParticipantCount >= currentMatch.max_players) {
                alert('Üzgünüz, bu maç siz katılmaya çalışırken doldu!');
                fetchMatches(); // UI'ı güncelle
                return;
            }

            // 1. Katılımcıyı match_participants tablosuna ekle
            const { error: participantInsertError } = await supabase
                .from('match_participants')
                .insert([ { match_id: matchId, participant_name: participantName.trim() } ]);

            if (participantInsertError) {
                console.error('Katılımcı eklenirken hata oluştu:', participantInsertError);
                alert('Maça katılırken bir hata oluştu: ' + participantInsertError.message);
                return;
            }

            // 2. matches tablosundaki current_players sayısını artır
            // Bu adımı, katılımcı sayısını match_participants'tan saydığımız için
            // opsiyonel hale getirebiliriz veya trigger ile Supabase tarafında yaptırabiliriz.
            // Şimdilik JS tarafında güncelleyelim.
            const newPlayerCount = actualParticipantCount + 1; // Yeni katılımcı eklendiği için +1

            const { error: updateError } = await supabase
                .from('matches')
                .update({ current_players: newPlayerCount })
                .eq('id', matchId);

            if (updateError) {
                // Bu hata kritik değil, katılımcı eklendi ama sayaç güncellenemedi.
                // Kullanıcıya bilgi verilebilir veya sadece loglanabilir.
                console.warn('Oyuncu sayısı güncellenirken hata oluştu (katılımcı eklendi):', updateError);
            }

            alert(`${participantName.trim()} olarak maça katıldınız!`);
            fetchMatches(); // UI'ı yenile
        }

        // Sayfa yüklendiğinde maçları çek
        fetchMatches();

        async function fetchParticipants(matchId) {
    const participantsList = document.getElementById(`participants-${matchId}`);
    if (!participantsList) return;

    const { data: participants, error } = await supabase
        .from('match_participants')
        .select('participant_name')
        .eq('match_id', matchId)
        .order('id', { ascending: true });

    if (error) {
        participantsList.innerHTML = '<li>Katılımcılar yüklenemedi</li>';
        return;
    }

    if (participants && participants.length > 0) {
        participantsList.innerHTML = participants
            .map(p => `<li>${p.participant_name}</li>`)
            .join('');
    } else {
        participantsList.innerHTML = '<li>Henüz katılımcı yok</li>';
    }
}
    </script>
</body>
</html>